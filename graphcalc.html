<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<script id="lineLinearPlotFragmentShader" type="x-shader/x-fragment">
		void main(void){
			gl_FragColor = vec4(0,0,0,1);
		}
	</script>

	<script id="lineLinearPlotVertexShader" type="x-shader/x-vertex">
		attribute vec3 vertexPos;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		void main(void){
			gl_Position = projectionMatrix * modelViewMatrix * vec4(vertexPos,1.0);
		}
	</script>

	<script id="lineFragmentShader" type="x-shader/x-fragment">
		void main(void){
			gl_FragColor = vec4(0,0,0,0.15);
		}
	</script>

	<script id="lineVertexShader" type="x-shader/x-vertex">
		attribute vec4 vertexPos;

		uniform mat4 modelViewMatrix;
		uniform mat4 projectionMatrix;

		void main(void){
			gl_Position = projectionMatrix * modelViewMatrix * vertexPos;
		}
	</script>

	<script type="text/javascript" src="lib/PhiloGL.min.js"></script>
	<script type="text/javascript">
	function initGraph(){
		if(!PhiloGL.hasWebGL())
			return;

		var userData = {
			render: null,
			translate: {x:0,y:0,z:-1},
			dragPrevious: {x:0,y:0},
		};

		var app = PhiloGL('graphcalc',{
			program: [
				{
					id: 'lineLinearPlot',
					from: 'ids',
					vs: 'lineLinearPlotVertexShader',
					fs: 'lineLinearPlotFragmentShader'
				},
				{
					id: 'line',
					from: 'ids',
					vs: 'lineVertexShader',
					fs: 'lineFragmentShader'
				},
			],
			onError: function(){
				console.log("Error while initializing WebGL");
			},
			onLoad: function(app){
				var gl      = app.gl,
				    canvas  = app.canvas,
				    camera  = app.camera,
				    lineLinearPlotShaderProgram = app.program.lineLinearPlot,
				    lineShaderProgram     = app.program.line;

				app.canvas.width  = window.innerWidth;
				app.canvas.height = window.innerHeight;
				gl.viewport(0,0,app.canvas.width,app.canvas.height);
				gl.clearColor(1,1,1,1);

				lineLinearPlotShaderProgram.setBuffers({
					'lineLinearPlot': {
						attribute: 'vertexPos',
						value: new Float32Array([
							0.0, 0.0, 0,
							1.0, 1.0, 0,
							1.5, 1.0, 0,
							4.0, 1.5, 0
						]),
						size: 3
					},

					'lineX': {
						attribute: 'vertexPos',
						value: new Float32Array([
							//+x
							 0.0, 0.0, 0.0, 1.0,
							 1.0, 0.0, 0.0, 0.0,

							//-x
							 0.0, 0.0, 0.0, 1.0,
							-1.0, 0.0, 0.0, 0.0,

							//+y
							 0.0, 0.0, 0.0, 1.0,
							 0.0, 1.0, 0.0, 0.0,

							//-y
							 0.0, 0.0, 0.0, 1.0,
							 0.0,-1.0, 0.0, 0.0,
						]),
						size: 4
					},
				});

				userData.render = function(){
					gl.clear(gl.COLOR_BUFFER_BIT);
					camera.view.id();
					camera.view.$translate(userData.translate.x,userData.translate.y,userData.translate.z);

					//Draw plot
					lineLinearPlotShaderProgram.use();
					lineLinearPlotShaderProgram.setUniform('modelViewMatrix',camera.view);
					lineLinearPlotShaderProgram.setUniform('projectionMatrix',camera.projection);
					lineLinearPlotShaderProgram.setBuffer('lineLinearPlot');
					gl.drawArrays(gl.LINE_STRIP,0,4);

					//Draw lines
					lineShaderProgram.use();
					lineShaderProgram.setUniform('modelViewMatrix',camera.view);
					lineShaderProgram.setUniform('projectionMatrix',camera.projection);
					lineShaderProgram.setBuffer('lineX');
					gl.drawArrays(gl.LINES,0,8);
				};
				userData.render();

				//Change viewport on resize of window
				window.addEventListener('resize',function(event){
					canvas.width  = window.innerWidth;
					canvas.height = window.innerHeight;
					gl.viewport(0,0,canvas.width,canvas.height);
					userData.render();
				});

				//Remove the fallback element because everything seems to be okay
				var elem = document.getElementById('fallback');
				elem.parentNode.removeChild(elem);
			},
			events: {
				disableContextMenu: true,
				onDragStart: function(event){
					userData.dragPrevious = {
						x: event.x,
						y: event.y
					};
				},
				onDragMove: function(event){
					userData.translate.x+=(event.x-userData.dragPrevious.x)/50;
					userData.translate.y+=(event.y-userData.dragPrevious.y)/50;

					userData.dragPrevious = {
						x: event.x,
						y: event.y
					};
					userData.render();
				},
				onMouseWheel: function(event){
					var newZ = userData.translate.z+event.wheel;
					if(newZ<0){
						userData.translate.z = newZ;
						userData.render();
					}
				}
			}
		});
	}
	</script>

	<style type="text/css">
	body{
		margin:0;
	}

	#graphcalc{
		position:absolute;
		width:100%;
		height:100%;
	}
	</style>

</head>

<body onload="initGraph();">
	<div id="fallback">Failed to render with WebGL</div>
	<canvas id="graphcalc"></canvas>
</body>
</html>
